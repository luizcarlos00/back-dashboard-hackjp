# FeedBreak Backend API ğŸš€

Backend API for FeedBreak - Educational platform using short videos with personalized E2E (Explain-to-Evaluate) questions.

## ğŸ—ï¸ Architecture

- **FastAPI** - Modern Python web framework
- **Supabase** - PostgreSQL database + file storage
- **LangChain + GPT-4o-mini** - AI-powered answer analysis
- **n8n** - Webhook integration for personalized question generation
- **Railway** - Cloud deployment

## ğŸ“‹ Features

### Core Features
- âœ… User management (profile with interests, education level)
- âœ… Video content delivery with progress tracking
- âœ… Personalized E2E questions (generated via n8n)
- âœ… Text and audio answer submission
- âœ… AI-powered answer analysis with feedback
- âœ… Dashboard with statistics and answer review

### API Endpoints

#### Users
- `POST /api/v1/user` - Create/update user profile
- `GET /api/v1/user/{device_id}` - Get user by device ID

#### Videos
- `GET /api/v1/videos` - List videos (with filters)
- `GET /api/v1/videos/content` - Alias for videos list
- `GET /api/v1/videos/next?device_id=X` - Get next video for user
- `GET /api/v1/videos/{video_id}` - Get specific video

#### Progress
- `POST /api/v1/progress` - Record video completion

#### Questions
- `GET /api/v1/questions?device_id=X&video_id=Y` - Generate E2E question
- `GET /api/v1/questions/prompts` - Get available prompts

#### Answers
- `POST /api/v1/answer` - Submit text answer (with AI analysis)
- `POST /api/v1/answer/audio` - Upload audio answer

#### Dashboard
- `GET /api/v1/dashboard/stats` - Get system statistics
- `GET /api/v1/dashboard/e2e` - Get answers for review

## ğŸš€ Quick Start

### Prerequisites

- Python 3.11+
- Supabase account
- OpenAI API key
- n8n instance (for personalized questions)

### 1. Setup Environment

Create a `.env` file in the `backend/` directory:

```bash
# Supabase Configuration
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_KEY=your_supabase_anon_key_here

# OpenAI Configuration
OPENAI_API_KEY=sk-your_openai_api_key_here

# n8n Webhook Configuration
N8N_WEBHOOK_URL=https://your-n8n-instance.com/webhook/generate-question

# Server Configuration
PORT=8000
```

### 2. Setup Supabase Database

1. Go to your Supabase project
2. Open SQL Editor
3. Run the schema from `app/database/schema.sql`
4. Create storage bucket:
   - Go to Storage
   - Create bucket named `e2e-audio`
   - Set to private
   - Configure policies as needed

### 3. Install Dependencies

```bash
cd backend
pip install -r requirements.txt
```

### 4. Run Locally

```bash
# Development mode with auto-reload
python -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000

# Or directly
python app/main.py
```

API will be available at:
- API: http://localhost:8000
- Docs: http://localhost:8000/docs
- Health: http://localhost:8000/health

## ğŸŒ Deploy to Railway

### Option 1: Using Railway CLI

```bash
# Install Railway CLI
npm install -g railway

# Login
railway login

# Initialize project
railway init

# Add environment variables
railway variables set SUPABASE_URL=https://...
railway variables set SUPABASE_KEY=...
railway variables set OPENAI_API_KEY=sk-...
railway variables set N8N_WEBHOOK_URL=https://...

# Deploy
railway up
```

### Option 2: Using Railway Dashboard

1. Connect your GitHub repository
2. Add environment variables in Railway dashboard
3. Railway will automatically detect `Procfile` and deploy

## ğŸ”§ n8n Webhook Configuration

Your n8n webhook should:

1. **Accept POST request** with JSON payload:
```json
{
  "user": {
    "nome": "JoÃ£o",
    "idade": 25,
    "interesses": ["ciÃªncia", "tecnologia"],
    "nivel_educacional": "superior"
  },
  "video": {
    "title": "Como funciona a fotossÃ­ntese",
    "description": "ExplicaÃ§Ã£o sobre o processo...",
    "expected_concepts": ["luz solar", "clorofila", "energia"]
  }
}
```

2. **Return JSON response**:
```json
{
  "question": "Baseado no que vocÃª aprendeu sobre fotossÃ­ntese, explique como as plantas usam a luz solar para produzir energia."
}
```

3. **Use OpenAI in n8n**:
   - Add OpenAI node
   - Use the user profile to personalize the question
   - Consider user's age, interests, and education level
   - Reference expected concepts from the video

## ğŸ“Š Database Schema

### Main Tables

1. **users** - User profiles with device_id, nome, idade, interesses, nivel_educacional
2. **videos** - Educational videos with metadata and expected_concepts
3. **user_progress** - Track which videos each user has watched
4. **questions** - E2E questions (generated by n8n or manual)
5. **answers** - User responses with AI evaluation
6. **e2e_prompts** - Base prompts for question generation

See `app/database/schema.sql` for complete schema.

## ğŸ§ª Testing

### Test Endpoints

```bash
# Health check
curl http://localhost:8000/health

# Create user
curl -X POST http://localhost:8000/api/v1/user \
  -H "Content-Type: application/json" \
  -d '{
    "device_id": "test-device-123",
    "nome": "Test User",
    "idade": 25,
    "interesses": ["ciencia", "tecnologia"],
    "nivel_educacional": "superior"
  }'

# Get next video
curl "http://localhost:8000/api/v1/videos/next?device_id=test-device-123"

# Record progress
curl -X POST http://localhost:8000/api/v1/progress \
  -H "Content-Type: application/json" \
  -d '{
    "device_id": "test-device-123",
    "video_id": "video-uuid-here",
    "completed": true
  }'

# Get question
curl "http://localhost:8000/api/v1/questions?device_id=test-device-123&video_id=video-uuid-here"

# Submit text answer
curl -X POST http://localhost:8000/api/v1/answer \
  -H "Content-Type: application/json" \
  -d '{
    "device_id": "test-device-123",
    "question_id": "question-uuid-here",
    "video_id": "video-uuid-here",
    "text_response": "FotossÃ­ntese Ã© o processo onde plantas convertem luz solar em energia..."
  }'

# Get dashboard stats
curl http://localhost:8000/api/v1/dashboard/stats
```

## ğŸ“ API Documentation

Once running, visit:
- Swagger UI: http://localhost:8000/docs
- ReDoc: http://localhost:8000/redoc

## ğŸ—ï¸ Project Structure

```
backend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ main.py                    # FastAPI app entry point
â”‚   â”œâ”€â”€ config.py                  # Environment configuration
â”‚   â”œâ”€â”€ models.py                  # Pydantic models
â”‚   â”œâ”€â”€ routers/
â”‚   â”‚   â”œâ”€â”€ users.py               # User endpoints
â”‚   â”‚   â”œâ”€â”€ videos.py              # Video endpoints
â”‚   â”‚   â”œâ”€â”€ progress.py            # Progress tracking
â”‚   â”‚   â”œâ”€â”€ questions.py           # E2E questions
â”‚   â”‚   â”œâ”€â”€ answers.py             # Answer submission
â”‚   â”‚   â””â”€â”€ dashboard.py           # Dashboard stats
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ langchain_analyzer.py  # AI answer analysis
â”‚   â”‚   â””â”€â”€ n8n_client.py          # n8n webhook client
â”‚   â””â”€â”€ database/
â”‚       â””â”€â”€ schema.sql              # Database schema
â”œâ”€â”€ requirements.txt
â”œâ”€â”€ Procfile                        # Railway deployment
â””â”€â”€ README.md
```

## ğŸ’¡ Key Features Explained

### Personalized E2E Questions

After watching N videos (default: 3), users receive a personalized "Explain-to-Evaluate" question:
1. System calls n8n webhook with user profile + video context
2. n8n uses OpenAI to generate question based on user's age, interests, education level
3. Question is saved and returned to user

### AI-Powered Answer Analysis

Text answers are analyzed using LangChain + GPT-4o-mini:
1. Evaluates understanding of key concepts
2. Calculates quality score (0.0 - 1.0)
3. Identifies concepts mentioned
4. Generates constructive feedback
5. Determines pass/fail (>= 0.6 = pass)

### Progress Tracking

System tracks:
- Videos watched per user
- When to trigger E2E questions
- View counts per video
- User activity timestamps

## ğŸ” Security Notes

**For Production:**
- Set specific CORS origins (not "*")
- Add rate limiting
- Implement proper authentication
- Secure Supabase RLS policies
- Use environment-specific API keys

## ğŸ“ Support

For issues or questions:
- Check API docs at `/docs`
- Review logs in Railway dashboard
- Test endpoints locally first

## ğŸ¯ Roadmap

Future enhancements:
- [ ] Audio transcription (Whisper API)
- [ ] User authentication (OAuth)
- [ ] Video recommendations engine
- [ ] Analytics dashboard improvements
- [ ] Admin panel for content management

---

**Built for Hackathon** | FastAPI + Supabase + LangChain + n8n

